#!/bin/bash
set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_DIR="$(dirname "$SCRIPT_DIR")"
VM_NAME="claude-agent"
CLOUD_INIT="$REPO_DIR/cloud-init.yaml"

# Require path argument
if [[ -z "$1" ]]; then
    echo "Usage: clorb <path>"
    echo "Example: clorb . | clorb ~/projects/my-app"
    exit 1
fi

# Resolve to absolute path
TARGET_PATH="$(cd "$1" && pwd)"

# Convert to VM path
VM_PATH="/mnt/mac${TARGET_PATH}"

# Check if VM exists
if ! orb list | grep -q "^$VM_NAME "; then
    echo "Creating VM '$VM_NAME'..."
    orb create ubuntu:noble "$VM_NAME" --user-data "$CLOUD_INIT"
    echo "Waiting for cloud-init to complete (this may take a minute)..."
    orb -m "$VM_NAME" cloud-init status --wait
fi

# Check if VM is running
if ! orb list | grep "^$VM_NAME " | grep -q "running"; then
    echo "Starting VM '$VM_NAME'..."
    orb start "$VM_NAME"
fi

echo "VM ready."

# Mount ~/.claude from Mac and run Claude
MAC_CLAUDE_DIR="$HOME/.claude"

orb -m "$VM_NAME" bash -c "
    # Ensure ~/.claude exists and is linked to Mac's
    mkdir -p ~/.claude

    # Bind mount Mac's .claude if not already mounted
    if ! mountpoint -q ~/.claude 2>/dev/null; then
        sudo mount --bind /mnt/mac${MAC_CLAUDE_DIR} ~/.claude 2>/dev/null || true
    fi

    # Add bun to PATH
    export BUN_INSTALL=\"\$HOME/.bun\"
    export PATH=\"\$BUN_INSTALL/bin:\$PATH\"

    # Change to project directory and run Claude
    cd '$VM_PATH'
    claude --dangerously-skip-permissions
"
