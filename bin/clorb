#!/bin/bash
set -e

# Resolve symlinks to get actual script location
SOURCE="${BASH_SOURCE[0]}"
while [[ -L "$SOURCE" ]]; do
    DIR="$(cd "$(dirname "$SOURCE")" && pwd)"
    SOURCE="$(readlink "$SOURCE")"
    [[ "$SOURCE" != /* ]] && SOURCE="$DIR/$SOURCE"
done
SCRIPT_DIR="$(cd "$(dirname "$SOURCE")" && pwd)"
REPO_DIR="$(dirname "$SCRIPT_DIR")"
VM_NAME="claude-agent"
CLOUD_INIT="$REPO_DIR/cloud-init.yaml"

# Check for OrbStack
if ! command -v orb &>/dev/null; then
    echo "Error: OrbStack is not installed."
    echo "Install it from: https://orbstack.dev"
    exit 1
fi

# Require path argument
if [[ -z "$1" ]]; then
    echo "Usage: clorb <path>"
    echo "Example: clorb . | clorb ~/projects/my-app"
    exit 1
fi

# Resolve to absolute path
TARGET_PATH="$(cd "$1" && pwd)"

# Convert to VM path
VM_PATH="/mnt/mac${TARGET_PATH}"

# Check if VM exists
if ! orb list | grep -q "^$VM_NAME "; then
    echo "Creating VM '$VM_NAME'..."
    orb create ubuntu:noble "$VM_NAME" --user-data "$CLOUD_INIT"
    echo "Waiting for cloud-init to complete (this may take a minute)..."
    if ! orb -m "$VM_NAME" cloud-init status --wait; then
        echo ""
        echo "cloud-init failed. Logs:"
        echo "----------------------------------------"
        orb -m "$VM_NAME" cat /var/log/cloud-init-output.log | tail -50
        echo "----------------------------------------"
        echo "Cleaning up failed VM..."
        orb delete -f "$VM_NAME"
        exit 1
    fi
fi

# Check if existing VM has failed cloud-init
if orb -m "$VM_NAME" cloud-init status 2>/dev/null | grep -q "status: error"; then
    echo "Existing VM has failed provisioning. Recreating..."
    orb delete -f "$VM_NAME"
    exec "$0" "$@"
fi

# Check if VM is running
if ! orb list | grep "^$VM_NAME " | grep -q "running"; then
    echo "Starting VM '$VM_NAME'..."
    orb start "$VM_NAME"
fi

echo "VM ready."

# Mount ~/.claude from Mac and run Claude
MAC_CLAUDE_DIR="$HOME/.claude"

orb -m "$VM_NAME" bash -c "
    # Ensure ~/.claude exists and is linked to Mac's
    mkdir -p ~/.claude

    # Bind mount Mac's .claude if not already mounted
    if ! mountpoint -q ~/.claude 2>/dev/null; then
        sudo mount --bind /mnt/mac${MAC_CLAUDE_DIR} ~/.claude 2>/dev/null || true
    fi

    # Add bun to PATH
    export BUN_INSTALL=\"\$HOME/.bun\"
    export PATH=\"\$BUN_INSTALL/bin:\$PATH\"

    # Change to project directory and run Claude
    cd '$VM_PATH'
    claude --dangerously-skip-permissions
"
