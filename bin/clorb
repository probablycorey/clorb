#!/bin/bash
set -e

# Resolve symlinks to get actual script location
SOURCE="${BASH_SOURCE[0]}"
while [[ -L "$SOURCE" ]]; do
    DIR="$(cd "$(dirname "$SOURCE")" && pwd)"
    SOURCE="$(readlink "$SOURCE")"
    [[ "$SOURCE" != /* ]] && SOURCE="$DIR/$SOURCE"
done
SCRIPT_DIR="$(cd "$(dirname "$SOURCE")" && pwd)"
REPO_DIR="$(dirname "$SCRIPT_DIR")"

IMAGE_NAME="clorb"

# Check for Docker
if ! command -v docker &>/dev/null; then
    echo "Error: Docker is not installed."
    echo "Install OrbStack from: https://orbstack.dev"
    exit 1
fi

# Require path argument
if [[ -z "$1" ]]; then
    echo "Usage: clorb <path>"
    echo "Example: clorb . | clorb ~/projects/my-app"
    exit 1
fi

# Resolve to absolute path
TARGET_PATH="$(cd "$1" && pwd)"

# Build image if it doesn't exist
if ! docker image inspect "$IMAGE_NAME" &>/dev/null; then
    echo "Building clorb image (first run only)..."
    docker build -t "$IMAGE_NAME" "$REPO_DIR"
fi

# Run Claude in container with only project and credentials mounted
docker run -it --rm \
    -v "$TARGET_PATH:/workspace" \
    -v "$HOME/.claude:/root/.claude" \
    -w /workspace \
    "$IMAGE_NAME" \
    --dangerously-skip-permissions

# Play notification sound when done
afplay /System/Library/Sounds/Glass.aiff 2>/dev/null &
