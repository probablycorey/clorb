#!/bin/bash
set -e

# Resolve symlinks to get actual script location
SOURCE="${BASH_SOURCE[0]}"
while [[ -L "$SOURCE" ]]; do
    DIR="$(cd "$(dirname "$SOURCE")" && pwd)"
    SOURCE="$(readlink "$SOURCE")"
    [[ "$SOURCE" != /* ]] && SOURCE="$DIR/$SOURCE"
done
SCRIPT_DIR="$(cd "$(dirname "$SOURCE")" && pwd)"
REPO_DIR="$(dirname "$SCRIPT_DIR")"

IMAGE_NAME="clorb"

usage() {
    cat <<EOF
clorb - Run Claude Code in an isolated Docker container

Usage: clorb [options] <path>

Arguments:
  <path>        Directory to mount and work in

Options:
  --gh          Enable GitHub CLI authentication (requires 'gh auth login')
  --rebuild     Rebuild the Docker image and exit
  -h, --help    Show this help message

Examples:
  clorb .                  Run Claude in the current directory
  clorb ~/projects/myapp   Run Claude in a specific project
  clorb --gh .             Run with GitHub CLI access for PRs and issues
  clorb --rebuild          Rebuild the container image
EOF
}

# Handle help flags
if [[ "$1" == "-h" || "$1" == "--help" ]]; then
    usage
    exit 0
fi

# Check for Docker
if ! command -v docker &>/dev/null; then
    echo "Error: Docker is not installed."
    echo "Install OrbStack from: https://orbstack.dev"
    exit 1
fi

# Handle --rebuild flag
if [[ "$1" == "--rebuild" ]]; then
    echo "Rebuilding clorb image..."
    docker build -t "$IMAGE_NAME" "$REPO_DIR"
    exit 0
fi

# Parse flags
MOUNT_GH=false
while [[ "$1" == --* ]]; do
    case "$1" in
        --gh)
            MOUNT_GH=true
            shift
            ;;
        *)
            echo "Error: Unknown option '$1'"
            echo
            usage
            exit 1
            ;;
    esac
done

# Require path argument
if [[ -z "$1" ]]; then
    usage
    exit 1
fi

# Resolve to absolute path and get directory name
TARGET_PATH="$(cd "$1" && pwd)"
DIR_NAME="$(basename "$TARGET_PATH")"

# Build image if it doesn't exist
if ! docker image inspect "$IMAGE_NAME" &>/dev/null; then
    echo "Building clorb image (first run only)..."
    docker build -t "$IMAGE_NAME" "$REPO_DIR"
fi

# Build docker run arguments
DOCKER_ARGS=(
    -it --rm
    -v "$TARGET_PATH:/$DIR_NAME"
    -v "clorb-claude-config:/home/clorb/.claude"
    -v "$HOME/.gitconfig:/tmp/.gitconfig-host:ro"
    -w "/$DIR_NAME"
)

if [[ "$MOUNT_GH" == true ]]; then
    GH_TOKEN=$(gh auth token 2>/dev/null)
    if [[ -z "$GH_TOKEN" ]]; then
        echo "Error: gh is not authenticated. Run 'gh auth login' first."
        exit 1
    fi
    DOCKER_ARGS+=(-e "GH_TOKEN=$GH_TOKEN")
fi

# Run Claude in container
docker run "${DOCKER_ARGS[@]}" "$IMAGE_NAME" --dangerously-skip-permissions
