#!/usr/bin/env bun

import { existsSync } from "fs";
import { resolve } from "path";
import { verifyGitStatus } from "./lib/preflight.ts";
import { dockerExists, buildImage, getGhToken, runContainer } from "./lib/docker.ts";
import { setupWorktree } from "./lib/worktree.ts";

const USAGE = `clorb - Run Claude Code in an isolated Docker container

Usage: clorb [options] <path>

Arguments:
  <path>        Directory to mount and work in (must be a git repo)

Options:
  --gh          Enable GitHub CLI authentication (requires 'gh auth login')
  --rebuild     Rebuild the Docker image and exit
  -h, --help    Show this help message

Behavior:
  clorb always creates a git worktree for isolated work. You'll be prompted
  for a branch name (press Enter for auto-generated name).

Examples:
  clorb .                  Run Claude in a new worktree (prompts for branch)
  clorb ~/projects/myapp   Run Claude in a specific project
  clorb --gh .             Run with GitHub CLI access for PRs and issues
  clorb --rebuild          Rebuild the container image`;

async function main() {
  const args = process.argv.slice(2);

  if (args.includes("-h") || args.includes("--help")) {
    console.log(USAGE);
    process.exit(0);
  }

  if (!(await dockerExists())) {
    console.error("Error: Docker is not installed.");
    console.error("Install OrbStack from: https://orbstack.dev");
    process.exit(1);
  }

  if (args.includes("--rebuild")) {
    await buildImage();
    process.exit(0);
  }

  // Parse flags
  let mountGh = false;
  const remaining: string[] = [];
  for (const arg of args) {
    if (arg === "--gh") mountGh = true;
    else if (!arg.startsWith("--")) remaining.push(arg);
    else {
      console.error(`Error: Unknown option '${arg}'\n`);
      console.log(USAGE);
      process.exit(1);
    }
  }

  if (remaining.length === 0) {
    console.log(USAGE);
    process.exit(1);
  }

  const targetPath = resolve(remaining[0]);
  if (!existsSync(targetPath)) {
    console.error(`Error: Path does not exist: ${targetPath}`);
    process.exit(1);
  }

  if (!(await verifyGitStatus(targetPath))) {
    process.exit(0);
  }

  // Always create worktree - prompt for branch name
  const branchInput = prompt("Branch name (press Enter for auto-generated):") || "";

  const result = await setupWorktree(targetPath, branchInput);

  if (result.error) {
    console.error(`Error: ${result.error}`);
    process.exit(1);
  }

  console.log(`Created worktree: ${result.worktreePath}`);
  console.log(`Branch: ${result.branchName}`);

  if (result.worktreeCount && result.worktreeCount > 5) {
    console.log(`\nNote: You have ${result.worktreeCount} worktrees in /tmp/clorb/`);
  }

  const containerPath = result.worktreePath!;

  let ghToken: string | null = null;
  if (mountGh) {
    ghToken = await getGhToken();
    if (!ghToken) {
      console.error("Error: gh is not authenticated. Run 'gh auth login' first.");
      process.exit(1);
    }
  }

  const exitCode = await runContainer(containerPath, ghToken);
  process.exit(exitCode);
}

main();
