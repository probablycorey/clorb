#!/bin/bash
set -e

# Resolve symlinks to get actual script location
SOURCE="${BASH_SOURCE[0]}"
while [[ -L "$SOURCE" ]]; do
    DIR="$(cd "$(dirname "$SOURCE")" && pwd)"
    SOURCE="$(readlink "$SOURCE")"
    [[ "$SOURCE" != /* ]] && SOURCE="$DIR/$SOURCE"
done
SCRIPT_DIR="$(cd "$(dirname "$SOURCE")" && pwd)"
REPO_DIR="$(dirname "$SCRIPT_DIR")"
VM_NAME="claude-agent"

# Check for OrbStack
if ! command -v orb &>/dev/null; then
    echo "Error: OrbStack is not installed."
    echo "Install it from: https://orbstack.dev"
    exit 1
fi

# Require path argument
if [[ -z "$1" ]]; then
    echo "Usage: clorb <path>"
    echo "Example: clorb . | clorb ~/projects/my-app"
    exit 1
fi

# Resolve to absolute path
TARGET_PATH="$(cd "$1" && pwd)"

# VM paths (used internally for mounting)
MAC_PROJECT_PATH="/mnt/mac${TARGET_PATH}"

# Check if VM exists
if ! orb list | grep -q "^$VM_NAME "; then
    echo "Creating VM '$VM_NAME'..."
    orb create ubuntu:noble "$VM_NAME"

    echo "Installing packages..."
    orb -m "$VM_NAME" sudo apt-get update
    orb -m "$VM_NAME" sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
        docker.io git ripgrep fd-find jq curl unzip nodejs

    echo "Installing Bun..."
    orb -m "$VM_NAME" bash -c 'curl -fsSL https://bun.sh/install | bash'

    echo "Installing Claude Code..."
    orb -m "$VM_NAME" bash -c 'export BUN_INSTALL="$HOME/.bun" && export PATH="$BUN_INSTALL/bin:$PATH" && bun install -g @anthropic-ai/claude-code'

    echo "Configuring Docker..."
    orb -m "$VM_NAME" bash -c 'sudo usermod -aG docker $(whoami)'

    echo "Provisioning complete."
fi

# Check if VM is running
if ! orb list | grep "^$VM_NAME " | grep -q "running"; then
    echo "Starting VM '$VM_NAME'..."
    orb start "$VM_NAME"
fi

echo "VM ready."

# Mount ~/.claude from Mac and run Claude
MAC_CLAUDE_DIR="$HOME/.claude"

orb -m "$VM_NAME" bash -c "
    # Mount only the project directory to /workspace (not full Mac filesystem)
    sudo mkdir -p /workspace
    if ! mountpoint -q /workspace 2>/dev/null; then
        sudo mount --bind '$MAC_PROJECT_PATH' /workspace
    fi
    sudo chown \$(whoami):\$(whoami) /workspace

    # Mount ~/.claude for credentials
    mkdir -p ~/.claude
    if ! mountpoint -q ~/.claude 2>/dev/null; then
        sudo mount --bind /mnt/mac${MAC_CLAUDE_DIR} ~/.claude 2>/dev/null || true
    fi

    # Add bun to PATH
    export BUN_INSTALL=\"\$HOME/.bun\"
    export PATH=\"\$BUN_INSTALL/bin:\$PATH\"

    # Work in isolated workspace
    cd /workspace
    claude --dangerously-skip-permissions
"
